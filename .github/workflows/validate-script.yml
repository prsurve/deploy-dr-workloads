name: Validate Python Script

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - '.github/workflows/validate-script.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - '.github/workflows/validate-script.yml'
  workflow_dispatch:

jobs:
  lint-and-validate:
    name: Lint and Validate Python Code
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
          pip install pylint flake8 black mypy
      
      - name: Check Python syntax
        run: |
          python -m py_compile deploy_workloads.py
      
      - name: Run flake8
        continue-on-error: true
        run: |
          flake8 deploy_workloads.py --max-line-length=120 --ignore=E501,W503
      
      - name: Run pylint
        continue-on-error: true
        run: |
          pylint deploy_workloads.py --disable=C0111,C0103,R0913,R0914,R0915 --max-line-length=120
      
      - name: Check code formatting with black
        continue-on-error: true
        run: |
          black --check --line-length=120 deploy_workloads.py || true
      
      - name: Type checking with mypy
        continue-on-error: true
        run: |
          mypy deploy_workloads.py --ignore-missing-imports || true

  dry-run-tests:
    name: Dry Run Tests
    runs-on: ubuntu-latest
    needs: lint-and-validate
    
    strategy:
      matrix:
        test-scenario:
          - name: "distributed-rbd-busybox"
            workload_type: "dist"
            workload: "busybox"
            pvc_type: "rbd"
          - name: "distributed-rbd-mysql"
            workload_type: "dist"
            workload: "mysql"
            pvc_type: "rbd"
          - name: "distributed-cephfs-busybox"
            workload_type: "dist"
            workload: "busybox"
            pvc_type: "cephfs"
          - name: "distributed-rbd-vm-pvc"
            workload_type: "dist"
            workload: "vm"
            pvc_type: "rbd"
            vm_type: "vm-pvc"
          - name: "distributed-rbd-vm-dv"
            workload_type: "dist"
            workload: "vm"
            pvc_type: "rbd"
            vm_type: "vm-dv"
          - name: "distributed-rbd-vm-dvt"
            workload_type: "dist"
            workload: "vm"
            pvc_type: "rbd"
            vm_type: "vm-dvt"
          - name: "appset-rbd-busybox"
            workload_type: "appset"
            workload: "busybox"
            pvc_type: "rbd"
          - name: "subscription-rbd-busybox"
            workload_type: "sub"
            workload: "busybox"
            pvc_type: "rbd"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Create mock directories and files
        run: |
          mkdir -p workload_data
          mkdir -p output_data
          mkdir -p mock_clusters
          
          # Create mock kubeconfig files
          echo "apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: https://mock-cluster1:6443
            name: cluster1" > mock_clusters/cluster1-kubeconfig
          
          echo "apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              server: https://mock-cluster2:6443
            name: cluster2" > mock_clusters/cluster2-kubeconfig
          
          # Create mock template files
          echo "---
          apiVersion: argoproj.io/v1alpha1
          kind: ApplicationSet
          metadata:
            name: sample
          spec:
            generators:
            - clusterDecisionResource:
                labelSelector:
                  matchLabels:
                    cluster.open-cluster-management.io/placement: sample
            template:
              metadata:
                name: sample
              spec:
                sources:
                - path: rdr/busybox/rbd/workloads/app-busybox-1
                  repoURL: https://github.com/example/repo.git
                  targetRevision: master
                destination:
                  namespace: sample
          ---
          apiVersion: cluster.open-cluster-management.io/v1beta1
          kind: Placement
          metadata:
            name: sample
          spec:
            predicates:
            - requiredClusterSelector:
                labelSelector:
                  matchExpressions:
                  - key: name
                    operator: In
                    values:
                    - cluster1
            clusterSets:
            - default
          ---
          apiVersion: ramendr.openshift.io/v1alpha1
          kind: DRPlacementControl
          metadata:
            name: sample
          spec:
            drPolicyRef:
              name: dr-policy
            placementRef:
              name: sample
            preferredCluster: cluster1
            pvcSelector:
              matchExpressions:
              - key: workloadpattern
                operator: In
                values:
                - simple_io_pvc" > workload_data/sample_appset_rbd.yaml
          
          echo "---
          apiVersion: v1
          kind: Namespace
          metadata:
            name: sub-rbd-1
          ---
          apiVersion: v1
          kind: Namespace
          metadata:
            name: channel-sub
          ---
          apiVersion: app.k8s.io/v1beta1
          kind: Application
          metadata:
            name: sample
            namespace: sample
          spec:
            selector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample
          ---
          apiVersion: apps.open-cluster-management.io/v1
          kind: Channel
          metadata:
            name: channel
            namespace: channel
          spec:
            pathname: https://github.com/example/repo.git
            type: Git
          ---
          apiVersion: apps.open-cluster-management.io/v1
          kind: Subscription
          metadata:
            name: sample-sub
            namespace: sample
            annotations:
              apps.open-cluster-management.io/git-branch: master
              apps.open-cluster-management.io/git-path: rdr/busybox/rbd/workloads/app-busybox-1
            labels:
              app: sample
          spec:
            channel: channel/channel
            placement:
              placementRef:
                name: sample-placs
          ---
          apiVersion: cluster.open-cluster-management.io/v1beta1
          kind: Placement
          metadata:
            name: sample-placs
            namespace: sample
            labels:
              app: sample
          spec:
            predicates:
            - requiredClusterSelector:
                labelSelector:
                  matchExpressions:
                  - key: name
                    operator: In
                    values:
                    - cluster1
            clusterSets:
            - default
          ---
          apiVersion: cluster.open-cluster-management.io/v1beta2
          kind: ManagedClusterSetBinding
          metadata:
            name: default
            namespace: sample
          spec:
            clusterSet: default
          ---
          apiVersion: ramendr.openshift.io/v1alpha1
          kind: DRPlacementControl
          metadata:
            name: sample-drpc
            namespace: sample
          spec:
            drPolicyRef:
              name: dr-policy
            placementRef:
              name: sample-placs
              namespace: sample
            preferredCluster: cluster1
            pvcSelector:
              matchExpressions:
              - key: workloadpattern
                operator: In
                values:
                - simple_io_pvc" > workload_data/sample_sub_rbd.yaml
          
          # Create mock DR templates
          echo "---
          apiVersion: cluster.open-cluster-management.io/v1beta1
          kind: Placement
          metadata:
            name: placement
            namespace: openshift-dr-ops
          spec:
            predicates:
            - requiredClusterSelector:
                labelSelector:
                  matchExpressions:
                  - key: name
                    operator: In
                    values:
                    - cluster1
            clusterSets:
            - default" > workload_data/placement.yaml
          
          echo "---
          apiVersion: ramendr.openshift.io/v1alpha1
          kind: DRPlacementControl
          metadata:
            name: drpc
          spec:
            drPolicyRef:
              name: dr-policy
            placementRef:
              name: placement
            preferredCluster: cluster1
            protectedNamespaces:
            - namespace
            pvcSelector:
              matchExpressions:
              - key: workloadpattern
                operator: In
                values:
                - simple_io_pvc
            kubeObjectProtection:
              kubeObjectSelector:
                matchExpressions:
                - key: workloadpattern
                  operator: In
                  values:
                  - simple_io" > workload_data/drpc.yaml
          
          echo "---
          apiVersion: ramendr.openshift.io/v1alpha1
          kind: Recipe
          metadata:
            name: recipe
          spec:
            appType: busybox
            groups:
            - name: group
              includedNamespaces:
              - namespace
              backupRef: backup
              labelSelector:
                matchExpressions:
                - key: workloadpattern
                  operator: In
                  values:
                  - simple_io
            workflows:
            - name: backup
              sequence:
              - hook: pre-backup
              - group: group
            - name: restore
              sequence:
              - group: group
            hooks:
            - name: pre-backup
              namespace: namespace
              nameSelector: busybox-*
            volumes:
              includedNamespaces:
              - namespace
              labelSelector:
                matchExpressions:
                - key: workloadpattern
                  operator: In
                  values:
                  - simple_io_pvc" > workload_data/recipe.yaml
          
          echo "---
          apiVersion: replication.storage.openshift.io/v1alpha1
          kind: VolumeGroupReplicationClass
          metadata:
            name: vrgc
            labels:
              ramendr.openshift.io/storageid: storage-id
              ramendr.openshift.io/replicationid: replication-id
          spec:
            provisioner: rbd.csi.ceph.com
            parameters:
              clusterID: cluster-id
              replication.storage.openshift.io/group-replication-secret-name: secret
              schedulingInterval: 5m" > workload_data/vrgc.yaml
          
          echo "---
          apiVersion: v1
          kind: Secret
          metadata:
            name: vm-secret
            namespace: default
          type: Opaque
          data:
            key: dmFsdWU=" > workload_data/vm-secret.yaml
          
          echo "---
          apiVersion: v1
          kind: Secret
          metadata:
            name: vm-secret-reg
            namespace: default
          type: Opaque
          data:
            key: dmFsdWU=" > workload_data/vm-secret-reg.yaml
          
          echo "---
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: vm-reg-cert
            namespace: default
          data:
            cert: certificate-data" > workload_data/vm-reg-cert.yaml
      
      - name: Create test configuration file
        run: |
          cat > test_config.yaml << EOF
          # Test Configuration
          c1_name: "cluster1"
          c1_kubeconfig: "mock_clusters/cluster1-kubeconfig"
          c2_name: "cluster2"
          c2_kubeconfig: "mock_clusters/cluster2-kubeconfig"
          
          workload_pvc_type: "${{ matrix.test-scenario.pvc_type }}"
          workload_type: "${{ matrix.test-scenario.workload_type }}"
          workload: "${{ matrix.test-scenario.workload }}"
          workload_count: 1
          
          output_dir: "test_${{ matrix.test-scenario.name }}"
          protect_workload: "yes"
          drpolicy_name: "test-dr-policy"
          
          clusterset: "default"
          repo_branch: "master"
          EOF
          
          # Add vm_type if specified
          if [ -n "${{ matrix.test-scenario.vm_type }}" ]; then
            echo "vm_type: \"${{ matrix.test-scenario.vm_type }}\"" >> test_config.yaml
          fi
      
      - name: Validate script arguments parsing
        run: |
          python3 deploy_workloads.py -config test_config.yaml --help || true
      
      - name: Test dry run - ${{ matrix.test-scenario.name }}
        run: |
          echo "Testing scenario: ${{ matrix.test-scenario.name }}"
          echo "Workload Type: ${{ matrix.test-scenario.workload_type }}"
          echo "Workload: ${{ matrix.test-scenario.workload }}"
          echo "PVC Type: ${{ matrix.test-scenario.pvc_type }}"
          
          # Note: This will fail at oc commands, but validates argument parsing and logic
          python3 deploy_workloads.py -config test_config.yaml -v 2>&1 | head -100 || true
      
      - name: Check output directory creation
        run: |
          ls -la output_data/ || true
      
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-artifacts-${{ matrix.test-scenario.name }}
          path: |
            output_data/
            test_config.yaml

  test-multi-namespace:
    name: Test Multi-Namespace Features
    runs-on: ubuntu-latest
    needs: lint-and-validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Create mock environment
        run: |
          mkdir -p workload_data output_data mock_clusters
          
          # Reuse mock file creation from previous job
          echo "apiVersion: v1
          kind: Config" > mock_clusters/cluster1-kubeconfig
          
          echo "apiVersion: v1
          kind: Config" > mock_clusters/cluster2-kubeconfig
      
      - name: Test multi-namespace with different counts
        run: |
          for ns_count in 1 2 5; do
            echo "Testing with multi_ns_workload=$ns_count"
            
            cat > multi_ns_config.yaml << EOF
          c1_name: "cluster1"
          c1_kubeconfig: "mock_clusters/cluster1-kubeconfig"
          c2_name: "cluster2"
          c2_kubeconfig: "mock_clusters/cluster2-kubeconfig"
          workload_pvc_type: "rbd"
          workload_type: "dist"
          workload: "busybox"
          workload_count: 2
          multi_ns_workload: $ns_count
          output_dir: "test_multi_ns_$ns_count"
          protect_workload: "yes"
          drpolicy_name: "test-dr-policy"
          clusterset: "default"
          EOF
            
            python3 deploy_workloads.py -config multi_ns_config.yaml -v 2>&1 | head -50 || true
          done

  test-all-options:
    name: Test All Command-Line Options
    runs-on: ubuntu-latest
    needs: lint-and-validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Test help output
        run: |
          python3 deploy_workloads.py --help
      
      - name: Test version and verbose flags
        run: |
          python3 deploy_workloads.py --verbose --help || true
          python3 deploy_workloads.py -v --help || true
      
      - name: Test all cluster strategies
        run: |
          for strategy in round_robin random least_loaded; do
            echo "Testing cluster_strategy: $strategy"
            python3 deploy_workloads.py \
              -cluster_strategy $strategy \
              --help || true
          done
      
      - name: Test all workload types
        run: |
          for wtype in dist appset sub; do
            echo "Testing workload_type: $wtype"
            python3 deploy_workloads.py \
              -workload_type $wtype \
              --help || true
          done
      
      - name: Test all PVC types
        run: |
          for pvc in rbd cephfs mix; do
            echo "Testing workload_pvc_type: $pvc"
            python3 deploy_workloads.py \
              -workload_pvc_type $pvc \
              --help || true
          done
      
      - name: Test all VM types
        run: |
          for vm in vm-pvc vm-dv vm-dvt; do
            echo "Testing vm_type: $vm"
            python3 deploy_workloads.py \
              -vm_type $vm \
              --help || true
          done

  test-error-handling:
    name: Test Error Handling
    runs-on: ubuntu-latest
    needs: lint-and-validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml
      
      - name: Test missing required arguments
        run: |
          python3 deploy_workloads.py 2>&1 | grep -i "missing required" || true
      
      - name: Test invalid workload type
        run: |
          python3 deploy_workloads.py \
            -workload_type invalid \
            2>&1 | grep -i "invalid choice" || true
      
      - name: Test invalid PVC type
        run: |
          python3 deploy_workloads.py \
            -workload_pvc_type invalid \
            2>&1 | grep -i "invalid choice" || true
      
      - name: Test CephFS with CG (should fail)
        run: |
          mkdir -p mock_clusters
          echo "test" > mock_clusters/test-kubeconfig
          
          python3 deploy_workloads.py \
            -workload_pvc_type cephfs \
            -workload_type dist \
            -workload_count 1 \
            -cg \
            -output_dir test \
            -protect_workload yes \
            -c1_name cluster1 \
            -c1_kubeconfig mock_clusters/test-kubeconfig \
            -c2_name cluster2 \
            -c2_kubeconfig mock_clusters/test-kubeconfig \
            2>&1 | grep -i "CephFS with CG" || echo "Expected error not found"
      
      - name: Test multi-ns with appset (should fail)
        run: |
          mkdir -p mock_clusters
          echo "test" > mock_clusters/test-kubeconfig
          
          python3 deploy_workloads.py \
            -workload_pvc_type rbd \
            -workload_type appset \
            -workload_count 1 \
            -multi_ns_workload 2 \
            -output_dir test \
            -protect_workload yes \
            -c1_name cluster1 \
            -c1_kubeconfig mock_clusters/test-kubeconfig \
            -c2_name cluster2 \
            -c2_kubeconfig mock_clusters/test-kubeconfig \
            2>&1 | grep -i "multi_ns_workload is only supported with" || echo "Expected error not found"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
      
      - name: Run Bandit security scan
        continue-on-error: true
        run: |
          bandit -r deploy_workloads.py -f json -o bandit-report.json || true
          bandit -r deploy_workloads.py || true
      
      - name: Check for known vulnerabilities in dependencies
        continue-on-error: true
        run: |
          pip install pyyaml
          safety check || true
      
      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: bandit-report.json

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint-and-validate, dry-run-tests, test-multi-namespace, test-all-options, test-error-handling, security-scan]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Lint and validation: ${{ needs.lint-and-validate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Dry run tests: ${{ needs.dry-run-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Multi-namespace tests: ${{ needs.test-multi-namespace.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ All options tests: ${{ needs.test-all-options.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Error handling tests: ${{ needs.test-error-handling.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Security scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Workload Types: dist, appset, sub" >> $GITHUB_STEP_SUMMARY
          echo "- Workloads: busybox, mysql, vm" >> $GITHUB_STEP_SUMMARY
          echo "- PVC Types: rbd, cephfs, mix" >> $GITHUB_STEP_SUMMARY
          echo "- VM Types: vm-pvc, vm-dv, vm-dvt" >> $GITHUB_STEP_SUMMARY
          echo "- Multi-namespace: 1, 2, 5" >> $GITHUB_STEP_SUMMARY
          echo "- Cluster Strategies: round_robin, random, least_loaded" >> $GITHUB_STEP_SUMMARY